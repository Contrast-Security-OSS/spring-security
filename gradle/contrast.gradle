buildscript {
    repositories {
        jcenter()
    }
    dependencies {
        classpath 'de.undercouch:gradle-download-task:1.1'
    }
}

apply plugin: de.undercouch.gradle.tasks.download.DownloadTaskPlugin

import de.undercouch.gradle.tasks.download.Download

task downloadContrastAgent(type: Download) {
    onlyIf { project.contrast_enable }
    logging.captureStandardOutput LogLevel.QUIET

    doFirst {
        println("Configuring Contrast")

                println("Contrast Agent not found - retrieving from server")
                println("Configuring Contrast API")
                def contrast_config = new XmlSlurper().parse(new File(project.contrast_config))
                def contrast_username = contrast_config.user.id.toString()
                def contrast_servicekey = contrast_config.user.key.toString()
                def contrast_apikey = contrast_config."global-key".toString()
                println("Configured for " + contrast_username)

                download {
                    src 'https://app.contrastsecurity.com/Contrast/api/engine/default/java?jvm=1.6'
                    dest System.getProperty("java.io.tmpdir") + '/contrast.jar'

                    def hdrAuth = (contrast_username + ":" + contrast_servicekey).bytes.encodeBase64().toString()

                    headers = [
                            "Authorization": hdrAuth,
                            "API-Key": contrast_apikey,
                            "Accept" : 'application/json'
                    ]
                }
            } else {
                println("Contrast Configuration is missing. Skipping Contrast Initialization")
                project.contrast_enable = false
            }
        } else {
            println("Contrast Agent Cached")
        }
    }
}